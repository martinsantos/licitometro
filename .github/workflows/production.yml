name: Production Deployment

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

# Permissions for creating issues on failure
permissions:
  contents: read
  issues: write

# Only one production deployment at a time
concurrency:
  group: production
  cancel-in-progress: false

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment:
      name: production
      url: https://licitometro.ar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        env:
          CI: true
          REACT_APP_BACKEND_URL: ""
        run: |
          npm ci
          npm run build
          echo "‚úÖ Frontend built ($(du -sh build | cut -f1))"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        env:
          VPS_KNOWN_HOSTS: ${{ secrets.VPS_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_KNOWN_HOSTS" >> ~/.ssh/known_hosts

      - name: Verify SSH connectivity
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Testing SSH connectivity to VPS..."
          # Retry up to 4 times with exponential backoff (2s, 4s, 8s, 16s)
          for attempt in 1 2 3 4; do
            if ssh -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=15 \
                   -o ServerAliveInterval=10 \
                   -o ServerAliveCountMax=3 \
                   "${VPS_USER}@${VPS_HOST}" "echo 'SSH OK'" 2>&1; then
              echo "‚úÖ SSH connection established on attempt ${attempt}"
              exit 0
            fi
            wait_time=$((2 ** attempt))
            echo "‚ö†Ô∏è  Attempt ${attempt} failed. Retrying in ${wait_time}s..."
            sleep $wait_time
          done
          echo "‚ùå Could not connect to VPS after 4 attempts."
          echo "Possible causes:"
          echo "  1. VPS is down or unreachable"
          echo "  2. Firewall blocking GitHub Actions IPs on port 22"
          echo "  3. SSH daemon not running on VPS"
          echo "  4. Secret VPS_HOST/VPS_USER incorrect"
          echo "Manual check: ssh ${VPS_USER}@${VPS_HOST}"
          exit 1

      - name: Sync code to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Syncing code to production VPS..."
          rsync -avz --delete --checksum \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'storage' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude '.env.production' \
            --exclude '.env.preview-*' \
            --exclude 'docker-compose.preview-*.yml' \
            --exclude 'docker-compose.caddy.yml' \
            -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=30 -o ServerAliveCountMax=20" \
            ./ "${VPS_USER}@${VPS_HOST}:/opt/licitometro/"

      - name: Deploy to production
        id: deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "Deploying to production..."
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          echo "Commit: ${COMMIT_SHORT}"

          ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=20 \
            "${VPS_USER}@${VPS_HOST}" \
            "cd /opt/licitometro && bash scripts/deploy-prod.sh"

      - name: Verify production health
        env:
          PROD_URL: https://licitometro.ar
        run: |
          echo "Verifying production health..."

          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "  Attempt ${ATTEMPT}/${MAX_ATTEMPTS}..."

            if curl -f -s "${PROD_URL}/api/health" > /dev/null 2>&1; then
              echo "‚úÖ Production is healthy!"
              exit 0
            fi

            sleep 10
          done

          echo "‚ùå Production health check failed"
          exit 1

      - name: Notify success
        if: success()
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          echo "‚úÖ Deployment successful!"
          echo "Commit: ${COMMIT_SHORT}"

      - name: Deployment failed - Create issue
        if: failure()
        uses: actions/github-script@v7
        env:
          COMMIT_SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const commitSha = process.env.COMMIT_SHA;
            const runId = process.env.RUN_ID;
            const commitShort = commitSha.substring(0, 7);

            const body = `## üö® Production Deployment Failed

            **Commit:** \`${commitShort}\`
            **Workflow:** [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})
            **Time:** ${new Date().toISOString()}

            ### Action Required
            1. Review workflow logs for errors
            2. Check VPS health and resources
            3. Verify deployment rolled back successfully
            4. Fix issues and re-deploy

            ### Quick Checks
            - [ ] VPS accessible via SSH
            - [ ] Docker containers running
            - [ ] Logs show errors
            - [ ] Resources exhausted

            <sub>Auto-generated issue by GitHub Actions</sub>`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production deployment failed (${commitShort})`,
              body: body,
              labels: ['deployment', 'critical', 'production']
            });
